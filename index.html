<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Solar Cost & Net-Metering Tool</title>
    <!-- Tailwind (Play CDN for quick styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React 18 UMD + Babel for in-browser JSX -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
      const { useMemo, useState } = React;

      // ===== Your App.jsx (converted to run in-browser) =====
      function App() {
        const [inputs, setInputs] = useState({
          pvSizeKw: 10,
          annualProdKWh: 20075,
          annualLoadKWh: 10950,
          discountRatePct: 6,
          analysisYears: 25,
          panelCostPerW: 1.2,
          inverterCostPerKw: 150,
          onmPctOfCapex: 1.0,
          batteryKWh: 48,
          batteryCostPerKWh: 350,
          batteryLifeYears: 12,
          offGridInverterAdderPerKw: 300,
          generatorReservePerYear: 200,
          buyRate: 0.20,
          sellRate: 0.10,
        });
        const set = (k, v) => setInputs((s) => ({ ...s, [k]: v }));

        const CRF = (r, n) => {
          if (r === 0) return 1 / n;
          const t = Math.pow(1 + r, n);
          return (r * t) / (t - 1);
        };

        const results = useMemo(() => {
          const {
            pvSizeKw, annualProdKWh, discountRatePct, analysisYears,
            panelCostPerW, inverterCostPerKw, onmPctOfCapex,
            batteryKWh, batteryCostPerKWh, batteryLifeYears,
            offGridInverterAdderPerKw, generatorReservePerYear,
            annualLoadKWh, buyRate, sellRate,
          } = inputs;

          const r = discountRatePct / 100;
          const crf = CRF(r, analysisYears);

          const onGridCapex = pvSizeKw * 1000 * panelCostPerW + pvSizeKw * inverterCostPerKw;
          const onGridAnnualOnM = (onmPctOfCapex / 100) * onGridCapex;
          const onGridAnnualizedCost = onGridCapex * crf + onGridAnnualOnM;
          const lcoeOnGrid = onGridAnnualizedCost / Math.max(annualProdKWh, 1);

          const batteryCapex = batteryKWh * batteryCostPerKWh;
          const batteryCRF = CRF(r, Math.max(1, Math.min(analysisYears, batteryLifeYears)));
          const offGridCapexBase = onGridCapex + pvSizeKw * offGridInverterAdderPerKw;
          const offGridAnnualOnM = (onmPctOfCapex / 100) * offGridCapexBase + generatorReservePerYear;
          const offGridAnnualized = offGridCapexBase * crf + batteryCapex * batteryCRF + offGridAnnualOnM;
          const lcoeOffGrid = offGridAnnualized / Math.max(annualLoadKWh, 1);

          const ratio = lcoeOffGrid / Math.max(lcoeOnGrid, 1e-9);

          const exportKWh = Math.max(0, annualProdKWh - annualLoadKWh);
          const importKWh = Math.max(0, annualLoadKWh - annualProdKWh);
          const annualBill = importKWh * buyRate - exportKWh * sellRate;

          let thresholdRatio = Infinity;
          if (importKWh > 0 && exportKWh > 0) {
            thresholdRatio = exportKWh / importKWh; // buy/sell = export/import
          }

          return {
            lcoeOnGrid, lcoeOffGrid, ratio,
            onGridCapex,
            offGridCapexBase: offGridCapexBase + batteryCapex,
            exportKWh, importKWh, annualBill, thresholdRatio,
          };
        }, [inputs]);

        const Field = ({ label, suffix, step = 0.01, min = 0, value, onChange }) => (
          <label className="flex items-center justify-between gap-3 py-1">
            <span className="text-sm text-slate-600">{label}</span>
            <input
              type="number" step={step} min={min} value={value}
              onChange={(e) => onChange(parseFloat(e.target.value))}
              className="w-32 rounded-md border border-slate-300 px-2 py-1 text-right"
            />
            {suffix && <span className="w-16 text-xs text-slate-500">{suffix}</span>}
          </label>
        );

        const Card = ({ title, children }) => (
          <div className="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
            <h3 className="mb-3 text-lg font-semibold text-slate-800">{title}</h3>
            {children}
          </div>
        );

        const Stat = ({ label, value, unit }) => (
          <div className="flex flex-col rounded-xl bg-slate-50 p-3 text-center">
            <div className="text-2xl font-semibold text-slate-800">
              {isFinite(value) ? value.toLocaleString(undefined, { maximumFractionDigits: 3 }) : "—"}{unit}
            </div>
            <div className="text-xs text-slate-500">{label}</div>
          </div>
        );

        return (
          <div className="mx-auto max-w-6xl space-y-6 p-6">
            <header className="space-y-1">
              <h1 className="text-2xl font-bold text-slate-900">Solar Cost & Net-Metering Tool</h1>
              <p className="text-sm text-slate-600">
                Compare on-grid vs off-grid LCOE and estimate net-metering outcomes. Edit the inputs; results update instantly.
              </p>
            </header>

            <div className="grid grid-cols-1 gap-4 md:grid-cols-3">
              <Card title="System & Energy">
                <Field label="PV Size" suffix="kW" value={inputs.pvSizeKw} onChange={(v) => set("pvSizeKw", v)} />
                <Field label="Annual Production" suffix="kWh/yr" value={inputs.annualProdKWh} onChange={(v) => set("annualProdKWh", v)} />
                <Field label="Annual Load" suffix="kWh/yr" value={inputs.annualLoadKWh} onChange={(v) => set("annualLoadKWh", v)} />
                <Field label="Discount Rate" suffix="%" value={inputs.discountRatePct} onChange={(v) => set("discountRatePct", v)} />
                <Field label="Analysis Horizon" suffix="years" step={1} value={inputs.analysisYears} onChange={(v) => set("analysisYears", v)} />
              </Card>

              <Card title="On-Grid Costs">
                <Field label="Installed Cost (Panels+BOS+Install)" suffix="$ / W" value={inputs.panelCostPerW} onChange={(v) => set("panelCostPerW", v)} />
                <Field label="Inverter Reserve" suffix="$ / kW" value={inputs.inverterCostPerKw} onChange={(v) => set("inverterCostPerKw", v)} />
                <Field label="O&M" suffix="% of CAPEX / yr" value={inputs.onmPctOfCapex} onChange={(v) => set("onmPctOfCapex", v)} />
              </Card>

              <Card title="Off-Grid Adders">
                <Field label="Battery" suffix="kWh" value={inputs.batteryKWh} onChange={(v) => set("batteryKWh", v)} />
                <Field label="Battery Cost" suffix="$ / kWh" value={inputs.batteryCostPerKWh} onChange={(v) => set("batteryCostPerKWh", v)} />
                <Field label="Battery Life" suffix="years" step={1} value={inputs.batteryLifeYears} onChange={(v) => set("batteryLifeYears", v)} />
                <Field label="Off-Grid Controls Adder" suffix="$ / kW" value={inputs.offGridInverterAdderPerKw} onChange={(v) => set("offGridInverterAdderPerKw", v)} />
                <Field label="Generator Reserve" suffix="$ / yr" value={inputs.generatorReservePerYear} onChange={(v) => set("generatorReservePerYear", v)} />
              </Card>
            </div>

            <div className="grid grid-cols-1 gap-4 md:grid-cols-3">
              <Card title="LCOE Results">
                <div className="grid grid-cols-2 gap-3">
                  <Stat label="On-Grid LCOE" value={results.lcoeOnGrid} unit=" $/kWh" />
                  <Stat label="Off-Grid LCOE" value={results.lcoeOffGrid} unit=" $/kWh" />
                  <Stat label="Off-Grid / On-Grid" value={results.ratio} unit=" ×" />
                  <Stat label="On-Grid CAPEX" value={results.onGridCapex} unit=" $" />
                  <Stat label="Off-Grid CAPEX (incl. battery)" value={results.offGridCapexBase} unit=" $" />
                </div>
                <p className="mt-3 text-xs text-slate-500">LCOE = (CAPEX × CRF + O&M + reserves) / Annual Energy.</p>
              </Card>

              <Card title="Net-Metering">
                <Field label="Buy Rate" suffix="$ / kWh" value={inputs.buyRate} onChange={(v) => set("buyRate", v)} />
                <Field label="Sell Rate" suffix="$ / kWh" value={inputs.sellRate} onChange={(v) => set("sellRate", v)} />
                <div className="grid grid-cols-2 gap-3 mt-2">
                  <Stat label="Annual Export" value={results.exportKWh} unit=" kWh" />
                  <Stat label="Annual Import" value={results.importKWh} unit=" kWh" />
                  <Stat label="Annual Bill (− credit)" value={results.annualBill} unit=" $/yr" />
                  <Stat label="Break-even Buy/Sell Ratio" value={results.thresholdRatio} unit=" ×" />
                </div>
              </Card>

              <Card title="How to read this">
                <ul className="list-disc pl-5 text-sm text-slate-600 space-y-2">
                  <li>Adjust PV size, production, and costs to match your case.</li>
                  <li>Compare <strong>LCOE</strong> values; storage drives off-grid higher.</li>
                  <li>Use Net-Metering to test buy/sell rates and credits.</li>
                </ul>
              </Card>
            </div>

            <footer className="text-xs text-slate-500">
              This simple tool uses annual averages and doesn’t model hourly variability.
            </footer>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
